name: Deploy Endless-Quest App to GitHub Pages

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [main] # åªåœ¨ push åˆ° main åˆ†æ”¯æ—¶éƒ¨ç½²
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: "20" # ä½¿ç”¨ LTS ç‰ˆæœ¬ï¼Œæ›´ç¨³å®šå¯é 
  BASE_PATH: "/endless-quest/" # ç»Ÿä¸€ç®¡ç†éƒ¨ç½²è·¯å¾„

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»è¦æœ‰å†™å…¥æƒé™

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²è®°å½•

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm" # ç¼“å­˜ npm ä¾èµ–

      # 3. ç¼“å­˜ node_modules ä»¥æé«˜æ„å»ºé€Ÿåº¦
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci # ä½¿ç”¨ ci è€Œä¸æ˜¯ installï¼Œä¿è¯ä¾èµ–ä¸€è‡´æ€§

      # 5. æ„å»ºé¡¹ç›®
      - name: Build with Vite
        run: npm run build
        env:
          NODE_ENV: github-io

      # 6. å¤„ç†å•é¡µåº”ç”¨è·¯ç”±é—®é¢˜ï¼ˆé‡è¦ï¼ï¼‰
      - name: Fix SPA routing for GitHub Pages
        run: |
          # åˆ›å»º .nojekyll æ–‡ä»¶ï¼Œé˜²æ­¢ GitHub Pages å¿½ç•¥ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶
          touch dist/.nojekyll

          # å¤åˆ¶ index.html ä¸º 404.htmlï¼Œè§£å†³ç›´æ¥è®¿é—®è·¯ç”±çš„ 404 é—®é¢˜
          cp dist/index.html dist/404.html

      # 7. éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          # è‡ªåŠ¨ç”Ÿæˆçš„ tokenï¼Œæ— éœ€é¢å¤–é…ç½®
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # æ„å»ºè¾“å‡ºç›®å½•
          publish_dir: ./dist

          # éƒ¨ç½²åˆ°çš„åˆ†æ”¯ï¼ˆé»˜è®¤ gh-pagesï¼‰
          publish_branch: gh-pages

          # ä¿æŒåˆ†æ”¯å¹²å‡€ï¼ˆåˆ é™¤æ—§æ–‡ä»¶ï¼‰
          force_orphan: true

          # æäº¤ä¿¡æ¯
          commit_message: "ğŸš€ Deploy: ${{ github.event.head_commit.message || github.sha }}"

          # æäº¤è€…ä¿¡æ¯
          user_name: "github-actions[bot]"
          user_email: "41898282+github-actions[bot]@users.noreply.github.com"

      # 8. è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: Output deployment info
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ”— è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io${{ env.BASE_PATH }}"
          echo "ğŸŒ¿ éƒ¨ç½²åˆ†æ”¯: gh-pages"
          echo "ğŸ†” æäº¤å“ˆå¸Œ: ${{ github.sha }}"
